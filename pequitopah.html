
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta

# Set page config
st.set_page_config(page_title="Queue Tracker", page_icon="ðŸ“…", layout="wide")

# Title
st.title("ðŸ“… Queue Tracker")
st.markdown("---")

# Queue configuration
queue_names = ["Pavel", "Guilherme", "Victor", "Chris", "Alan", "Thiago", "Clayton", "Carolina"]
start_date = datetime(2025, 10, 13)  # October 13, 2025 (Victor's start date)
victor_index = queue_names.index("Victor")  # Victor is at index 2

# Current date
today = datetime.now().date()
st.info(f"Today: {today.strftime('%d/%m/%Y')}")

def get_person_for_date(target_date):
    """Get the person assigned for a specific date"""
    days_since_start = (target_date - start_date.date()).days
    # Victor started, so we need to account for his position in the queue
    person_index = (victor_index + days_since_start) % len(queue_names)
    return queue_names[person_index]

def get_next_date_for_person(person_name, from_date=None):
    """Get the next date when a specific person will be assigned"""
    if from_date is None:
        from_date = today

    person_index = queue_names.index(person_name)

    # Calculate days until this person's turn
    current_person_index = (victor_index + (from_date - start_date.date()).days) % len(queue_names)

    if person_index >= current_person_index:
        days_until = person_index - current_person_index
    else:
        days_until = len(queue_names) - current_person_index + person_index

    return from_date + timedelta(days=days_until)

# Current status
st.header("ðŸŽ¯ Current Status")
current_person = get_person_for_date(today)
st.success(f"**Today's turn: {current_person}**")

# Show current queue with dates
st.header("ðŸ“‹ Current Queue (Next 8 Days)")

queue_data = []
for i in range(8):
    date = today + timedelta(days=i)
    person = get_person_for_date(date)
    status = "TODAY" if i == 0 else f"+{i} days"
    queue_data.append({
        "Date": date.strftime("%d/%m/%Y"),
        "Day": date.strftime("%A"),
        "Person": person,
        "Status": status
    })

df_queue = pd.DataFrame(queue_data)

# Highlight today's row
def highlight_today(row):
    if row["Status"] == "TODAY":
        return ['background-color: #90EE90'] * len(row)
    return [''] * len(row)

st.dataframe(df_queue.style.apply(highlight_today, axis=1), use_container_width=True)

# Future predictions
st.header("ðŸ”® Future Predictions")

col1, col2 = st.columns(2)

with col1:
    st.subheader("Next turn for each person:")
    prediction_data = []

    for person in queue_names:
        next_date = get_next_date_for_person(person)
        days_until = (next_date - today).days

        prediction_data.append({
            "Person": person,
            "Next Date": next_date.strftime("%d/%m/%Y"),
            "Days Until": days_until if days_until > 0 else "Today" if days_until == 0 else "Past"
        })

    df_predictions = pd.DataFrame(prediction_data)
    st.dataframe(df_predictions, use_container_width=True)

with col2:
    st.subheader("Queue Cycle Info:")
    st.info(f"""
    **Queue Length:** {len(queue_names)} people
    **Full Cycle:** {len(queue_names)} days
    **Started:** {start_date.strftime('%d/%m/%Y')} (Victor)
    **Current Position:** {queue_names.index(current_person) + 1}/{len(queue_names)}
    """)

# Calendar view for next month
st.header("ðŸ“† Extended Calendar View")

# Allow user to select how many days to show
days_to_show = st.slider("Days to show:", min_value=7, max_value=60, value=30)

calendar_data = []
for i in range(days_to_show):
    date = today + timedelta(days=i)
    person = get_person_for_date(date)
    calendar_data.append({
        "Date": date.strftime("%d/%m"),
        "Day": date.strftime("%a"),
        "Person": person,
        "Full Date": date.strftime("%d/%m/%Y")
    })

df_calendar = pd.DataFrame(calendar_data)

# Display in chunks of 7 days (week view)
st.subheader("Weekly View:")
for week_start in range(0, len(calendar_data), 7):
    week_end = min(week_start + 7, len(calendar_data))
    week_data = df_calendar.iloc[week_start:week_end]

    cols = st.columns(7)
    for idx, (_, day_info) in enumerate(week_data.iterrows()):
        if idx < len(cols):
            with cols[idx]:
                if week_start == 0 and idx == 0:  # Highlight today
                    st.success(f"**{day_info['Date']}**\n{day_info['Day']}\n**{day_info['Person']}**")
                else:
                    st.info(f"**{day_info['Date']}**\n{day_info['Day']}\n{day_info['Person']}")

# Statistics
st.header("ðŸ“Š Statistics")
col1, col2, col3 = st.columns(3)

with col1:
    days_since_start = (today - start_date.date()).days
    st.metric("Days Since Start", days_since_start)

with col2:
    complete_cycles = days_since_start // len(queue_names)
    st.metric("Complete Cycles", complete_cycles)

with col3:
    current_cycle_day = (days_since_start % len(queue_names)) + 1
    st.metric("Current Cycle Day", f"{current_cycle_day}/{len(queue_names)}")
